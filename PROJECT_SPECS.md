# Документация проекта Proryv LMS

## 1. ТЗ / Требования по ключевым модулям

Проект представляет собой образовательную платформу (LMS) с ролевой моделью (Ученик, Куратор, Администратор).

### Ключевые модули:

#### 1. Модуль Обучения (LMS Core)
*   **Иерархия контента:** Курсы -> Модули -> Уроки.
*   **Типы уроков:** Видео (Cloudflare Stream), Текст/Лонгрид, Тест/Квиз, Задание.
*   **Управление доступом:**
    *   Drip-контент (открытие по расписанию или событию).
    *   Ограничение по тарифам (VIP, Standard) и группам.
    *   Стоп-уроки (нельзя пройти дальше без выполнения).

#### 2. Модуль Пользователей и Ролей (Auth & RBAC)
*   **Роли:**
    *   **Student:** Просмотр курсов, сдача ДЗ, профиль, достижения.
    *   **Curator:** Проверка ДЗ (Inbox), обратная связь, чат с учеником.
    *   **Admin:** Управление контентом, пользователями, группами, аналитика.
*   **Безопасность:**
    *   Two-Factor Authentication (2FA).
    *   Управление сессиями (мониторинг устройств).
    *   Защита видео от скачивания (Signed URLs).

#### 3. Модуль Домашних Заданий (Homework & Quizzes)
*   **Задания:** Текстовые ответы, загрузка файлов.
*   **Рецензирование:** Интерфейс куратора для принятия/отклонения, комментарии, аудио-фидбек.
*   **Тесты:** Автоматическая проверка, попытки, проходной балл.

#### 4. Коммуникация и Уведомления
*   **Каналы:** Email, Telegram (планируется), Внутренние уведомления.
*   **События:** Новое ДЗ, ДЗ проверено, Новый урок открыт.

---

## 2. Архитектура решения

### Стек технологий
*   **Frontend & Backend:** Next.js 14+ (App Router), TypeScript.
*   **Database:** PostgreSQL (via Prisma ORM).
*   **Styling:** Tailwind CSS, Shadcn/UI.
*   **Video Streaming:** Cloudflare Stream.
*   **Infra:** Docker, Docker Compose.

### Схема данных (Ключевые сущности)
*   `User`: Хранение профиля, роли, тарифа.
*   `Course` / `Module` / `Lesson`: Дерево обучения.
*   `Enrollment`: Связь User <-> Course (статус, сроки).
*   `HomeworkSubmission`: Связь User <-> Lesson (контент ответа, статус, файлы).
*   `AuditLog`: Логирование действий администраторов.

### API и Интеграции
*   **Internal API:** Next.js API Routes (`app/api/*`) для фронтенда.
*   **Внешние сервисы:**
    *   **Cloudflare Stream:** Загрузка (`tus` protocol), хранение и стриминг видео.
    *   **SMTP:** Отправка Email уведомлений.
    *   **Telegram Bot API:** Интеграция для уведомлений и управления обучением (внешний сервис).

---

## 3. ML-пакет (Machine Learning & AI)

В проекте используется гибридный подход с использованием внешних LLM API.

### Описание данных и моделей
1.  **Транскрибация (ASR):**
    *   **Сервис:** AssemblyAI.
    *   **Вход:** Аудиодорожка из видеоурока.
    *   **Выход:** Текст с таймкодами (SRT/JSON), диаризация спикеров.

2.  **Генерация и Анализ (NLU/LLM):**
    *   **Модели:** `anthropic/claude-4.5-sonnet` (основная), OpenAI GPT-4o (вспомогательная).
    *   **Платформа:** Replicate API / OpenAI API.
    *   **Задачи:**
        *   Саммаризация уроков.
        *   Генерация квизов на основе транскрипта.
        *   AI-ассистент для кураторов (черновик ответа).

### Эксперименты и Метрики
*   **Было:** Использование GPT-3.5 для генерации — низкая точность контекста, галлюцинации в таймкодах.
*   **Стало:** Переход на Claude 3.5/4.5 Sonnet — улучшение семантического понимания на 40%, корректная работа с длинными контекстами (до 200k токенов).

---

## 4. Протоколы тестирования

### Функциональное тестирование
*   **Unit Tests:** Vitest. Покрытие утилитных функций (`lib/utils.ts`, `lib/auth.ts`).
*   **E2E Tests:** Playwright. Сценарии: регистрация, вход, покупка курса, прохождение урока.

### Нагрузочное тестирование (Load Testing)
В проекте реализованы скрипты для симуляции высокой нагрузки (`scripts/load-test.ts`, `scripts/full-simulation.ts`).

*   **Инструмент:** Custom TypeScript scripts (axios + async/await concurrency).
*   **Сценарий:**
    1.  Регистрация 100+ виртуальных пользователей.
    2.  Генерация сессий и токенов.
    3.  Параллельные запросы к API (`GET /api/courses`, `GET /api/me`) с RPS ~50-100.
*   **Метрики:**
    *   RPS (Requests Per Second).
    *   Latency (среднее время ответа).
    *   Error Rate (процент 5xx/4xx ошибок).

### Валидация NLU/Бота
*   **Методика:** Сравнение сгенерированного ответа с эталонным ("Golden Set" ответов кураторов).
*   **Дефекты:**
    *   Ошибки в терминологии (исправлено промпт-инжинирингом).
    *   Потеря контекста в длинных диалогах (решено через Summary-buffer память).

---

## 5. Практика в браузере

Сценарии выполнения практических заданий пользователем.

### 1. Сценарии заданий
*   **Текстовый ответ:** Ученик пишет эссе или код прямо в редакторе на странице.
*   **Файл:** Загрузка `.zip`, `.pdf`, `.mp4`.
*   **Квиз:** Выбор вариантов ответа (Single/Multi choice), сопоставление.

### 2. Доступ к среде (Environment)
Для заданий, требующих сложной настройки окружения (DevOps, Backend), предусмотрены:
*   **Внешние ссылки:** Переход в предознастроенные репозитории (GitHub Template).
*   **Docker/VM (Roadmap):** Планируется интеграция с Judge0 или аналогичными сервисами для запуска кода в изолированных контейнерах.

### 3. Автопроверка
*   **Квизы:** Мгновенная обратная связь (Правильно/Неправильно).
*   **Линтеры:** Для кода — проверка синтаксиса перед отправкой (Client-side validation).
